rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() { return request.auth != null; }
    function getUserRole() {
       let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
       return userDoc != null ? userDoc.data.role : 'guest';
    }
    function isAdmin() {
      return isAuthenticated() && (
        getUserRole() == 'admin'
      );
    }
    function isMusician() { return isAuthenticated() && (getUserRole() == 'musician' || isAdmin()); }
    function isSacristan() { return isAuthenticated() && (getUserRole() == 'sacristan' || isAdmin()); }
    function isSecretary() { return isAuthenticated() && (getUserRole() == 'secretary' || isAdmin()); }

    // --- REGLAS ---

    match /users/{userId} {
      allow read: if isAuthenticated();
      // SECURITY FIX: Prevent users from escalating their own role.
      // Users can write to their own doc.
      // IF creating (resource == null): Role must be 'guest'.
      // IF updating: Cannot modify 'role'.
      allow write: if isAdmin() || (request.auth.uid == userId && (
        resource == null ? request.resource.data.role == 'guest' :
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])
      ));
    }

    match /songs/{songId} {
      allow read: if true; // Público para el "Boletín Digital" (QR)
      allow write: if isMusician() || isAdmin();
    }

    match /liturgies/{liturgyId} {
      allow read, write: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid || isAdmin());
    }

    // --- SECURED COLLECTIONS ---
    match /intentions/{dateId} {
      allow read: if isAuthenticated(); 
      allow write: if isSecretary() || isAdmin();
    }

    match /sacristy_checks/{dateId} {
      allow read: if isAuthenticated();
      allow write: if isSacristan() || isAdmin();
    }

    match /config/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- MISSING COLLECTIONS FIX ---
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /stats/{statId} {
      allow read: if isAuthenticated();
      allow write: if isSacristan() || isAdmin();
    }
    
    // Contenido General (Notices, etc)
    match /content/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isSecretary() || isSacristan() || isMusician() || getUserRole() == 'treasurer' || getUserRole() == 'acolyte';
    }
    // ----------------------------------------------

    match /transactions/{docId} { allow read, write: if isAdmin() || getUserRole() == 'treasurer'; }
    match /inventory/{docId} { allow read, write: if isAdmin() || isSacristan(); }
    match /active_duties/{dutyId} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /messages/{msgId} { allow read, write: if isAuthenticated(); }
    // FIX: Add rule for Despacho / Certificates
    match /certificates/{certId} { allow read, write: if isSecretary() || isAdmin(); }
    
    // --- NUEVOS MODULOS ---
    
    // Setlists (Cantoral)
    match /setlists/{setlistId} {
      allow read: if true; // Público para QR
      allow write: if isMusician();
    }
    
    // Rosters (Roles)
    match /rosters/{rosterId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isSacristan();
    }
    
    // User Subcollections
    match /users/{userId}/availability/{docId} {
      allow read: if isAuthenticated(); // Roster builder needs to read all
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    match /users/{userId}/annotations/{docId} {
      allow read, write: if request.auth.uid == userId;
    }

    match /users/{userId}/notifications/{notifId} {
      allow read: if request.auth.uid == userId;
      allow write: if isAdmin(); // System/Admins send notifications
    }
    
    match /{document=**} { allow read, write: if false; }
  }
}
