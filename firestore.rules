rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user's role from their user profile document
    // Note: This costs 1 Read operation.
    // For high-traffic apps, use Custom Claims (requires Cloud Functions).
    function getUserRole() {
       let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
       return userDoc != null ? userDoc.data.role : 'guest'; // Safely handle missing doc
    }

    // Role Checks
    function isAdmin() {
      return isAuthenticated() && (
        getUserRole() == 'admin' || 
        request.auth.token.email == 'alexveo855@gmail.com' || 
        request.auth.token.email == 'gonzalezmatusalexis@gmail.com'
      );
    }

    function isSacristan() {
      // Sacristan implies Admin access in some contexts, but let's keep it specific
      // or allow Admin to act as Sacristan too.
      return isAuthenticated() && (getUserRole() == 'sacristan' || getUserRole() == 'admin');
    }
    
    function isSecretary() {
      return isAuthenticated() && (getUserRole() == 'secretary' || getUserRole() == 'admin');
    }

    // --- Collections ---

    // 1. Users Collection
    // - Everyone authenticated can read (to form the directory list)
    // - Only Admin can create/delete/change roles
    // - Users can update their OWN DisplayName (Profile Modal)
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Allow Admin to manage everything.
      // Allow Users to update their OWN profile (except role).
      // Allow Authenticated users to create/update MANUAL directory entries (origin == 'directory_manual').
      allow update: if isAdmin() 
                    || (request.auth.uid == userId && (!('role' in request.resource.data) || request.resource.data.role == resource.data.role))
                    || (isAuthenticated() && resource.data.origin == 'directory_manual'); 
                    
      allow create: if isAdmin() 
                    || (request.auth.uid == userId)
                    || (isAuthenticated() && request.resource.data.origin == 'directory_manual');
      
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.origin == 'directory_manual');
    }

    // 2. Inventory (Insumos)
    // - Read: All Authenticated
    // - Write: Admin or Sacristan
    match /inventory/{docId} {
      allow read: if isAuthenticated();
      allow write: if isSacristan();
    }

    // 3. Intentions (Intenciones)
    // - Read: All Authenticated (Priest needs to read, Secretary writes)
    // - Write: Admin or Secretary
    match /intentions/{dateId} {
      allow read: if isAuthenticated();
      allow write: if isSecretary();
    }

    // 4. Transactions (Finanzas)
    // - Read/Write: ONLY Admin or Secretary or Treasurer.
    match /transactions/{docId} {
      allow read, write: if isSecretary() || getUserRole() == 'treasurer';
    }

    // 5. Sacristy Checks (Checklist)
    // - Read: All Authenticated
    // - Write: Sacristan or Admin
    match /sacristy_checks/{dateId} {
      allow read: if isAuthenticated();
      allow write: if isSacristan();
    }

    // 6. Messages (Chat)
    // - Read/Write: All Authenticated Users
    match /messages/{msgId} {
      allow read, write: if isAuthenticated();
    }

    // Default: Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
