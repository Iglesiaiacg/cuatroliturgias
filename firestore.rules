rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() { return request.auth != null; }
    function getUserRole() {
       let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
       return userDoc != null ? userDoc.data.role : 'guest';
    }
    function isAdmin() {
      return isAuthenticated() && (
        getUserRole() == 'admin' || 
        request.auth.token.email == 'alexveo855@gmail.com' // PRIMACÍA TOTAL
      );
    }
    function isMusician() { return isAuthenticated() && (getUserRole() == 'musician' || isAdmin()); }
    function isSacristan() { return isAuthenticated() && (getUserRole() == 'sacristan' || isAdmin()); }
    function isSecretary() { return isAuthenticated() && (getUserRole() == 'secretary' || isAdmin()); }

    // --- REGLAS ---

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || request.auth.uid == userId;
    }

    match /songs/{songId} {
      allow read: if isAuthenticated();
      allow write: if isMusician() || isAdmin();
    }

    match /liturgies/{liturgyId} {
      allow read, write: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid || isAdmin());
    }

    // --- DIAGNOSTICO: LECTURA ABIERTA TEMPORAL ---
    match /intentions/{dateId} {
      allow read: if true; 
      allow write: if isSecretary();
    }

    match /sacristy_checks/{dateId} {
      allow read: if true;
      allow write: if isSacristan();
    }

    match /config/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Contenido General (Notices, etc)
    match /content/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isSecretary() || isSacristan() || isMusician() || getUserRole() == 'treasurer' || getUserRole() == 'acolyte';
    }
    // ----------------------------------------------

    match /transactions/{docId} { allow read, write: if isAdmin() || getUserRole() == 'treasurer'; }
    match /inventory/{docId} { allow read, write: if isAdmin() || isSacristan(); }
    match /active_duties/{dutyId} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /messages/{msgId} { allow read, write: if isAuthenticated(); }
    
    // --- NUEVOS MODULOS ---
    
    // Setlists (Cantoral)
    match /setlists/{setlistId} {
      allow read: if true; // Público para QR
      allow write: if isMusician();
    }
    
    // Rosters (Roles)
    match /rosters/{rosterId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isSacristan();
    }
    
    // User Subcollections
    match /users/{userId}/availability/{docId} {
      allow read: if isAuthenticated(); // Roster builder needs to read all
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    match /users/{userId}/annotations/{docId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    match /{document=**} { allow read, write: if false; }
  }
}
